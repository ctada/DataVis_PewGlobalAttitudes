<!DOCTYPE html>
<html>
  
  <head>
    
    <meta charset="utf-8">
    <title>Project 3 | China's Problems</title>

    <!-- load D3 library -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>

    <style>

text {
    font-family: sans-serif;
}

 .bar { 
     stroke: white;
     stroke-width: 2px;
     fill: blue;
 }

 .value {
     font-weight: bold;
     font-size: 16px;
     fill: blue;
 }

 .label {
     font-size: 20px;
 }

 .title {
     font-weight: bold;
     font-size: 20px;
     fill: black;
 }

div.center {
     position: absolute;
     width: 800px;
     height: 500px;
     top: 50%;
     left: 50%;
     margin-top: -250px;
     margin-left: -400px;
}

span.top-align {
  vertical-align: top;
}

    </style>

  </head>
  
  <body>


    <div>
      <span>
	<span class="top-align">Problem Size:</span>
	<select class="filter" id="select-size" multiple></select>
    </div>
    <div>
    <svg id="viz" height="500" width="800" style="border: 1px solid grey;">
    </svg>
    </div>

    <script>


/*
 * Demo: social media 2014 (fake data)
 * 
 */


// call run when the page finishes loading
      
window.addEventListener("load",run);
      
function run () {
    initializeView();
    // get data, call f when done
    getDataRows(function(data) {
        populateSelectors(data);
	setupEventListeners();
	DATA.all = data;
	updateData() });
}


function setupEventListeners () { 
    d3.selectAll("select.filter")
	.on("change",updateData)
}


var DATA = { all: []};

var ISSUES = ["Air Pollution",
		    "Corrupt Business People",
		    "Conditions for Workers",
		    "Unemployment",
		    "Safety of Food", 
		    "Water Pollution",
		    "Quality of Manufactured Goods",
		    "Health care",
		    "Education",
		    "Crime", 
		    "Corrupt Officials",
		    "Old age Insurance",
		    "Safety of Medicine", 
		    "Traffic",
		    "Electricity Shortages"];

function populateSelectors (data) { 
    var problem_sizes = d3.set();

    data.forEach(function(r) {
	problem_sizes.add(r.Q17A);
    });
    d3.select("#select-size")
	.selectAll("option")
	.data(problem_sizes.values().sort())
	.enter()
	.append("option")
	.attr("value",function(d) { return d; })
        .property("selected",true)
	.text(function(d) { return d;});
   
}

function isSelected (selectorId,val) {
    return d3.select('#'+selectorId+' > option[value="'+val+'"]')
	.property("selected");
}

function initializeView () { 

    var svg = d3.select("#viz");

    // get the size of the SVG element
    var height = svg.attr("height");
    var width = svg.attr("width");

    // the chart lives in the svg surrounded by a margin of 100px
    var margin = 100;
    var chartHeight = height - 2*margin;
    var chartWidth = width - 2*margin;

    // figure out the width of the bars so that all bars fit and 
    //   there is one bar width between them
    // note that every data point now has _2_ bars associated with 
    //   it
    var barWidth = chartWidth/(2*ISSUES.length-1);

    svg.append("text")
	.attr("class","title")
	.attr("x",width/2)
 	.attr("y",margin/2)
	.attr("dy","0.3em")
	.style("text-anchor","middle");

    sel = svg.selectAll("g")
	.data(ISSUES)
	.enter().append("g")

    sel.append("rect")
	.attr("class","bar")
	.attr("x",function(d,i) { return margin+(i*2)*barWidth; })
	.attr("y",height-margin)
	.attr("width",barWidth)
	.attr("height",0);

    sel.append("text")
	.attr("class","value")
	.attr("x",function(d,i) { return margin+(i*2)*barWidth+barWidth/2; })
 	.attr("y",height-margin-20)
	.attr("dy","0.3em")
	.style("text-anchor","middle");

    sel.append("text")
	.attr("class","label")
	.attr("x",function(d,i) { return margin+(i*2)*barWidth+barWidth/2; })
	.attr("y",margin+chartHeight+50)
	.attr("dy","0.3em")
	.style("text-anchor","middle")
	.text(function(d) { return d; });
}



function updateData () { 

    console.log("UPDATING DATA");

    var svg = d3.select("#viz");

    var height = svg.attr("height");
    var margin = 100;
    var chartHeight = height - 2*margin;


    ///svg.select(".title")
	///.text("Year: "+year);

    // crunch data
    // tabulate totals for each company
    // tabulate # of Yeses
    var COLUMN = 
	 {"Air Pollution":"Q17A",
    "Corrupt Business People":"Q17B",
    "Conditions for Workers":"Q17C",
    "Unemployment":"Q17D",
    "Safety of Food":"Q17E", 
    "Water Pollution":"Q17F",
    "Quality of Manufactured Goods":"Q17G",
    "Health care":"Q17H",
    "Education":"Q17I",
    "Crime":"Q17J", 
    "Corrupt Officials":"Q17K",
    "Old age Insurance":"Q17L",
    "Safety of Medicine":"Q17M", 
    "Traffic":"Q17N",
    "Electricity Shortages":"Q17O"};
    var counts = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
    var total_count = 0;
    DATA.all.forEach(function(r) { 
	if (isSelected("select-size",r.Q17A)  ){ //&&
	    //isSelected("select-age",r.age) &&
	    //isSelected("select-race",r.race)){
	    total_count += 1;
	    ISSUES.forEach(function(m,i) {
		if (r[COLUMN[m]]==="Very big problem") { 
		    counts[i] += 1;
		}
	    });
	}
    });

    d3.select("#span-base")
	.text(total_count);
    
    var yPos = d3.scale.linear()
	.domain([0,total_count])
	.range([height-margin,margin]);

    var height = d3.scale.linear()
	.domain([0,total_count])
	.range([0,chartHeight]);

    sel = svg.selectAll("g")
	.data(counts);

    sel.select(".bar")
	.transition(2000)
	.attr("y",function(d) { return yPos(d); })
	.attr("height",function(d) { return height(d); });

    sel.select(".value")
	.transition(2000)
	.attr("y",function(d) { return yPos(d) - 20; })
//	.text(function(d) { return (Math.round(100*d/total_count))+"%"; });
	.text(function(d) { return d; });

}		 


/* depending on your browser and your local configuration,
   you may need to have a web server deliver the file data.csv
   just use the default python web server */

function getDataRows (f) {
    d3.csv("http://localhost:8000/data.csv",
	   function(error,data) {
               console.log(data);
	       f(data);
	   });
}
      
    </script>
    
  </body>
  
</html>
