<!DOCTYPE html>
<html>
  
  <head>
    <meta charset="utf-8">
    <title>Social Media Viz Demo</title>

    <!-- load D3 library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <style>

text {
    font-family: sans-serif;
}

 .bar { 
     stroke: white;
     stroke-width: 2px;
     fill: blue;
 }

 .value {
     font-weight: bold;
     font-size: 16px;
     fill: blue;
 }

 .label {
     font-size: 20px;
 }

 .title {
     font-weight: bold;
     font-size: 20px;
     fill: black;
 }

div.center {
     position: absolute;
     width: 800px;
     height: 500px;
     top: 50%;
     left: 50%;
     margin-top: -250px;
     margin-left: -400px;
}

span.top-align {
  vertical-align: top;
}

    </style>

  </head>
  
  <body>

    <div>
        <div>
          <button type="button" class="btn btn-primary"id="button_q30">Will China replace US?</button>
          <button type="button" class="btn btn-primary"id="button_q120">Is US enemy of China?</button>
          <button type="button" class="btn btn-primary"id="button_q84">Moral Questions</button>
        </div>
    
    <span>
	     <span class="top-align">Country:</span>
	     <select class="filter" id="select-country" multiple></select>
    </span>
    
    </div>
    
    <div>
    <svg id="viz" height="500" width="800" style="border: 1px solid grey;">
    </svg>
    </div>

    <script>

      
window.addEventListener("load",run);
      
function run () {

    button_q30.addEventListener("click",function() { runquestion30();});
    button_q120.addEventListener("click",function() { runquestion120(); });
    button_q84.addEventListener("click",function() { runquestion84() });
}

function runquestion30 (){
  initializeView(ANSWERq30);
   getDataRows(function(data) {
    populateSelectors(data);
  setupEventListeners(updateDataq30);
  DATAq30.all = data;
  console.log(DATAq30);
  updateDataq30() });
}

function runquestion120(){
  initializeView(ANSWERq120);
   getDataRows(function(data) {
    populateSelectors(data);
  setupEventListeners(updateDataq120);
  DATAq120.all = data;
  // console.log(DATAq120);
  updateDataq120() });
}

function setupEventListeners (updatewhichdata) { 
    d3.selectAll("select.filter")
	.on("change",updatewhichdata)
}

var DATAq30 = { all: []};
var DATAq120 = { all: []};
var ANSWERq30 = ["Has already replaced U.S.","Will eventually replace U.S.","Will never replace U.S."]
var ANSWERq120 = ["More of a partner","More of an enemy","Neither"]

function populateSelectors (data) { 
    var country = d3.set();
    var q30 = d3.set();
    var q120 = d3.set();
    data.forEach(function(r) {
      country.add(r.COUNTRY);
	    q30.add(r.Q30);
      q120.add(r.Q120);
    });

  d3.select("#select-country")
	.selectAll("option")
	.data(country.values()) //sort not needed
	.enter()
	.append("option")
	.attr("value",function(d) { return d; })
    .property("selected",true)
	.text(function(d) { return d;});

  d3.select("#select-Q30")
	.selectAll("option")
	.data(q30.values().sort)
	.enter()
	.append("option")
	.attr("value",function(d) { return d; })
        .property("selected",true)
	.text(function(d) { return d;});

  d3.select("#select-Q120")
  .selectAll("option")
  .data(q30.values().sort)
  .enter()
  .append("option")
  .attr("value",function(d) { return d; })
        .property("selected",true)
  .text(function(d) { return d;});

}

function isSelected (selectorId,val) {
    return d3.select("#"+selectorId+" > option[value='"+val+"']")
	.property("selected");
}

function initializeView (dataset) { 

    var svg = d3.select("#viz");

    // get the size of the SVG element
    var height = svg.attr("height");
    var width = svg.attr("width");

    // the chart lives in the svg surrounded by a margin of 100px
    var margin = 100;
    var chartHeight = height - 2*margin;
    var chartWidth = width - 2*margin;
    var barWidth = chartWidth/(2*dataset.length-1);

  svg.append("text")
	.attr("class","title")
	.attr("x",width/2)
 	.attr("y",margin/2)
	.attr("dy","0.3em")
	.style("text-anchor","middle");

  sel = svg.selectAll("g")
	.data(dataset)
	.enter().append("g")

   sel.append("rect")
	.attr("class","bar")
	.attr("x",function(d,i) { return margin+(i*2)*barWidth; })
	.attr("y",height-margin)
	.attr("width",barWidth)
	.attr("height",0);

    sel.append("text")
	.attr("class","value")
	.attr("x",function(d,i) { return margin+(i*2)*barWidth+barWidth/2; })
 	.attr("y",height-margin-20)
	.attr("dy","0.3em")
	.style("text-anchor","middle");

    sel.append("text")
	.attr("class","label")
	.attr("x",function(d,i) { return margin+(i*2)*barWidth+barWidth/2; })
	.attr("y",margin+chartHeight+50)
	.attr("dy","0.3em")
	.style("text-anchor","middle")
	.text(function(d) { return d; });
}



function updateDataq30 (numquestion) { 
    console.log("UPDATING DATA", numquestion);
    var svg = d3.select("#viz");

    var height = svg.attr("height");
    var margin = 100;
    var chartHeight = height - 2*margin;

    svg.select(".title")
	.text("Country:" );

    var counts = [0,0,0];
    var total_count = 0;

       DATAq30.all.forEach(function(r) { 
	     if (isSelected("select-country",r.COUNTRY)){
	       total_count += 1;
         ANSWERq30.forEach(function(m,i) {
       if(r.Q30 === m){
            counts[i]+=1;
        }
        });
        }
        });
  d3.select("#span-base")
	.text(total_count);
    
   var yPos = d3.scale.linear()
	.domain([0,total_count])
	.range([height-margin,margin]);

   var height = d3.scale.linear()
	.domain([0,total_count])
	.range([0,chartHeight]);

   sel = svg.selectAll("g")
	.data(counts);

   sel.select(".bar")
	.transition(2000)
	.attr("y",function(d) { return yPos(d); })
	.attr("height",function(d) { return height(d); });

   sel.select(".value")
	.transition(2000)
	.attr("y",function(d) { return yPos(d) - 20; })
//	.text(function(d) { return (Math.round(100*d/total_count))+"%"; });
	.text(function(d) { return d; });

}		 

function updateDataq120 () { 
    console.log("UPDATING DATA");
    var svg = d3.select("#viz");

    var height = svg.attr("height");
    var margin = 100;
    var chartHeight = height - 2*margin;

   svg.select(".title")
   .text("Is US enemy of China?" );

    var counts = [0,0,0];
    // var total_count = 0;

       DATAq120.all.forEach(function(r) { 
       if (r.COUNTRY==="China"){
       ANSWERq120.forEach(function(m,i) {
       if(r.Q30 === m){
            console.log(r.Q30);
            counts[i]+=1;
        }
        });
     }
        });
  // d3.select("#span-base")
  // .text(total_count);
    
   var yPos = d3.scale.linear()
  // .domain([0,total_count])
  .range([height-margin,margin]);

   var height = d3.scale.linear()
  // .domain([0,total_count])
  .range([0,chartHeight]);

   sel = svg.selectAll("g")
  .data(counts);

   sel.select(".bar")
  .transition(2000)
  .attr("y",function(d) { return yPos(d); })
  .attr("height",function(d) { return height(d); });

   sel.select(".value")
  .transition(2000)
  .attr("y",function(d) { return yPos(d) - 20; })
//  .text(function(d) { return (Math.round(100*d/total_count))+"%"; });
  .text(function(d) { return d; });

}    
/* depending on your browser and your local configuration,
   you may need to have a web server deliver the file data.csv
   just use the default python web server */

function getDataRows (f) {
    d3.csv("apac.csv",
	   function(error,data) {
               console.log(data);
	       f(data);
	   });
}
      
    </script>
    
  </body>
  
</html>
