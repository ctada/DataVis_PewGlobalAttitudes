<!DOCTYPE html>
<html>
  
  <head>
    
    <meta charset="utf-8">
    <title>Project 3 | China's Problems</title>

    <!-- load D3 library -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>

    <style>

text {
    font-family: sans-serif;
}

 .value {
     font-weight: bold;
     font-size: 16px;
     fill: blue;
 }

 .label {
     font-size: 20px;
 }

 .title {
     font-weight: bold;
     font-size: 20px;
     fill: black;
 }

div.center {
     position: absolute;
     width: 800px;
     height: 500px;
     top: 50%;
     left: 50%;
     margin-top: -250px;
     margin-left: -400px;
}

span.top-align {
  vertical-align: top;
}

    </style>

  </head>
  
  <body>

    <button id ="button_q17">General</button>
    <button id ="button_q21">Economics</button>
    <div>
    </svg>
    </div>

    <script>


// call run when the page finishes loading
      
window.addEventListener("load",run);
      
function run () {

  getDataRows(function(data) {
    DATA.all = data;
    drawSVG();
  });

  button_q17.addEventListener("click",function() 
      { d3.selectAll("svg").style("display","none");
        d3.select("#viz17").style("display","block"); 
      });
  button_q21.addEventListener("click",function() 
      { d3.selectAll("svg").style("display","none");
        d3.select("#viz21").style("display","block"); 
      });
}
function drawSVG(){
  var height = 800;
  var width = 800;
  var margin = 10;
  var questions = ["17", "21"];

  for (var i in questions){
    q = questions[i];
    //create SVGS
    var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.setAttribute("width", width);
    svg.setAttribute("height", height);
    svg.setAttribute("x", margin);
    svg.setAttribute("y", margin);
    svg.setAttribute("id", "viz"+q);
    //svg.setAttribute("display","none");
    document.body.appendChild(svg);

    console.log("svg", q);
    //initialize visualization

    processData(q);
    // var ct= processData(q)[0];
    // var scores = processData(q)[1];
    // createList(q, ct, scores);// });
  }
  
}

var DATA = { all: []};

function processData (q) { 

    // crunch data
    // tabulate totals for response
    if (q==="17"){
       var COLUMN = 
     {"Air Pollution":"Q17A",
      "Corrupt Business People":"Q17B",
      "Conditions for Workers":"Q17C",
      "Unemployment":"Q17D",
      "Safety of Food":"Q17E", 
      "Water Pollution":"Q17F",
      "Quality of Manufactured Goods":"Q17G",
      "Health care":"Q17H",
      "Education":"Q17I",
      "Crime":"Q17J", 
      "Corrupt Officials":"Q17K",
      "Old age Insurance":"Q17L",
      "Safety of Medicine":"Q17M", 
      "Traffic":"Q17N",
      "Electricity Shortages":"Q17O"};
      console.log('17');
    }
    if (q==="21"){
       var COLUMN = 
     {"Rising prices":"Q21A",
      "Lack of Employment Opportunities":"Q21B",
      "Gap between Rich and Poor":"Q21C",
      "Public Debt":"Q21D"};
      console.log("21");
    }
   

    var problem_score = [];
    for (var i in d3.keys(COLUMN)){
      problem_score.push(0);
    }
    console.log(problem_score);
    var counts = [0,0,0,0]; //veryCt, modCt, smallCt, notCt
    var total_count = 0; //should be 3226 respondents * 15 issues, not counting "Don't Know"s, etc. 
    DATA.all.forEach(function(r) { 
	    d3.keys(COLUMN).forEach(function(m,i) {
  		if (r[COLUMN[m]]==="Very big problem") { 
		    problem_score[i] += 4;
        counts[0] +=1;
        total_count += 1;
  		}
      else if (r[COLUMN[m]]==="Moderately big problem"){
        problem_score[i] += 3;
        counts[1] +=1;
        total_count += 1;
      }
      else if (r[COLUMN[m]]==="Small problem"){
        problem_score[i] += 2;
        counts[2] +=1;
        total_count += 1;
      }
      else if (r[COLUMN[m]]==="Not a problem at all"){
        problem_score[i] += 1;
        counts[3] +=1;
        total_count += 1;
      }
	    });
	});
//   console.log(total_count, problem_score);
//   return [total_count, problem_score];
// }

// function createList(q,total_count, problem_score){
    var svg = d3.select("#viz"+q);
    console.log("#viz"+q)
    // get the size of the SVG element
    var height = svg.attr("height");
    var width = svg.attr("width");

    var margin = 20;
    var chartHeight = height - 2*margin;
    var chartWidth = width - 2*margin;
    var padding = 5; 
    var barWidth = chartWidth;
    var maxBarHeight = parseInt(chartHeight/problem_score.length); 

    yPos = margin; // start list of topics at top

  // creating group for button press, bind data
  changing_bars = svg.selectAll("g")
    .data(problem_score)
    .enter().append("g")
  // creating bars tied to the data

  var color = d3.scale.linear() //scale color of problem based on spectrum of minimum problem_score to maximum 
    .domain([1*total_count/problem_score.length, 4*total_count/problem_score.length]) // min: 1*total_count/problem_score.length; max = 4*total_count/problem_score.length
    .range(["lightgrey", "red"]);

  var barHeight = d3.scale.linear()
    .domain([d3.min(problem_score), d3.max(problem_score)]) //scale from problem_score minimum to maximum 
    .range([10,maxBarHeight]);

  changing_bars.append('rect')
      .attr("class","bar")
      .attr('x', margin)
      .attr('y', function(d,i){yPos0= yPos; yPos=yPos0+ barHeight(d) + padding; return yPos0;})
      .attr('width', barWidth)
      .attr('height', function(d, i){return barHeight(d);})
      .attr('fill', function(d,i){return color(d);}); 
  
  yPos = margin; 
    // creating and styling text labels
  changing_bars.append("text")
    .attr("class","value")
    .text(function(d,i){return d3.keys(COLUMN)[i];})
    .attr("x",function(d, i){return chartWidth/2;})
    .attr("y", function(d,i){yPos0= yPos; yPos=yPos0+ barHeight(d) + padding; return .5*barHeight(d) + yPos0;})
    .attr("dy", "0.3em")
    .style("text-anchor","middle")
    .style("font-family","sans-serif")
    .style("font-weight","bold")
    .style("font-size","12px")
    .style("fill", "white");
}		 


/* depending on your browser and your local configuration,
   you may need to have a web server deliver the file data.csv
   just use the default python web server */

function getDataRows (f) {
    d3.csv("http://localhost:8000/data.csv",
	   function(error,data) {
               //console.log(data);
	       f(data);
	   });
}
      
    </script>
    
  </body>
  
</html>
